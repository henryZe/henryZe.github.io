# RISC-V Reader

## 1 ä¸ºä»€ä¹ˆè¦æœ‰RISC-Vï¼Ÿ

**æˆæœ¬**

- åŸå› åœ¨äºç›®å‰çš„ç¡…ç”Ÿäº§å·¥è‰ºä¼šåœ¨æ™¶åœ†ä¸Šç•™ä¸‹ä¸€äº›æ•£å¸ƒçš„å°ç‘•ç–µã€‚å› æ­¤æ™¶ç²’è¶Šå°ï¼Œæœ‰ç¼ºé™·éƒ¨åˆ†æ‰€å æ¯”é‡ä¼šè¶Šä½ã€‚
- cost â‰ˆ f(die area^2) æˆæœ¬ä¸é¢ç§¯çº¦ä¸ºå¹³æ–¹å…³ç³»ã€‚

**ç®€æ´æ€§**

**æ€§èƒ½**

![perf](./1st/perf.png)

**æ¶æ„å’Œå…·ä½“å®ç°çš„åˆ†ç¦»**

**ç¨‹åºå¤§å°**

**æ˜“äºç¼–ç¨‹/ç¼–è¯‘/é“¾æ¥**

## 2 RV32Iï¼šRISC-V åŸºç¡€æ•´æ•°æŒ‡ä»¤é›†

![i_set](./2nd/i_set.png)

### 2.2 æŒ‡ä»¤æ ¼å¼

![i_type](./2nd/i_type.png)

å…­ç§åŸºæœ¬æŒ‡ä»¤æ ¼å¼:
1. å¯„å­˜å™¨-å¯„å­˜å™¨æ“ä½œçš„ R ç±»å‹æŒ‡ä»¤
2. çŸ­ç«‹å³æ•°å’Œè®¿å­˜ load æ“ä½œçš„ I å‹æŒ‡ä»¤
3. è®¿å­˜ store æ“ä½œçš„ S å‹æŒ‡ä»¤
4. æ¡ä»¶è·³è½¬æ“ä½œçš„ B ç±»å‹æŒ‡ä»¤
5. é•¿ç«‹å³æ•°çš„ U å‹æŒ‡ä»¤
6. æ— æ¡ä»¶è·³è½¬çš„ J å‹æŒ‡ä»¤

**ä¹±åºæ‰§è¡Œå¤„ç†å™¨**
> è¿™æ˜¯ä¸€ç§é«˜é€Ÿçš„ã€æµæ°´åŒ–çš„å¤„ç†å™¨ã€‚å®ƒä»¬ä¸€æœ‰æœºä¼šå°±æ‰§è¡ŒæŒ‡ä»¤ï¼Œè€Œä¸æ˜¯åœ¨æŒ‰ç…§ç¨‹åºé¡ºåºã€‚è¿™ç§å¤„ç†å™¨çš„ä¸€ä¸ªå…³é”®ç‰¹æ€§æ˜¯å¯„å­˜å™¨é‡å‘½åï¼ŒæŠŠç¨‹åºä¸­çš„å¯„å­˜å™¨åç§°æ˜ å°„åˆ°å¤§é‡çš„å†…éƒ¨ç‰©ç†å¯„å­˜å™¨ã€‚æ¡ä»¶æ‰§è¡Œçš„é—®é¢˜æ˜¯ä¸ç®¡æ¡ä»¶æ˜¯å¦æˆç«‹ï¼Œéƒ½å¿…é¡»ç»™è¿™äº›æŒ‡ä»¤ä¸­çš„å¯„å­˜å™¨åˆ†é…ç›¸åº”çš„ç‰©ç†å¯„å­˜å™¨ã€‚ä½†å†…éƒ¨ç‰©ç†å¯„å­˜å™¨çš„å¯ç”¨æ€§æ˜¯å½±å“ä¹±åºå¤„ç†å™¨çš„å…³é”®æ€§èƒ½èµ„æºã€‚

### 2.3 å¯„å­˜å™¨

![i_reg](./2nd/i_reg.png)

### 2.4 æ•´æ•°è®¡ç®—

* ç®—æœ¯æŒ‡ä»¤ add, sub
* é€»è¾‘æŒ‡ä»¤ and, or, xor
* ç§»ä½æŒ‡ä»¤ sll, srl, sra

**åˆ©ç”¨ xor æŒ‡ä»¤è¿›è¡Œçš„èŠ±å¼æ“ä½œ**
> å¯ä»¥åœ¨ä¸ä½¿ç”¨ä¸­é—´å¯„å­˜å™¨çš„æƒ…å†µä¸‹äº¤æ¢ä¸¤ä¸ªå€¼ï¼æ­¤ä»£ç äº¤æ¢ x1 å’Œ x2 çš„å€¼ã€‚æç¤ºï¼šå¼‚æˆ–æ“ä½œæ˜¯äº¤æ¢çš„ (ğ‘ âŠ• ğ‘ = ğ‘ âŠ• ğ‘)ï¼Œç»“åˆçš„ ((ğ‘ âŠ• ğ‘) âŠ• ğ‘ = ğ‘ âŠ• (ğ‘ âŠ• ğ‘))ï¼Œæ˜¯å®ƒè‡ªå·±çš„é€†æ“ä½œ (ğ‘ âŠ• ğ‘ = 0)ï¼Œå¹¶ä¸”æœ‰ä¸€ä¸ªå•ä½å…ƒ(ğ‘ âŠ• 0 = ğ‘)ã€‚

~~~ asm
xor x1,x1,x2 # x1â€™ == x1^x2, x2â€™ == x2
xor x2,x1,x2 # x1â€™ == x1^x2, x2â€™ == x1â€™^x2 == x1^x2^x2 == x1
xor x1,x1,x2 # x1â€ == x1â€™^x2â€™ == x1^x2^x1 == x1^x1^x2 == x2, x2â€™ == x1
~~~

### 2.5 Load å’Œ Store

**å­—èŠ‚åºé—®é¢˜**
> RISC-V é€‰æ‹© little endian

### 2.6 æ¡ä»¶åˆ†æ”¯

**ä¸ä½¿ç”¨æ¡ä»¶ç å®ç°å¤§ä½å®½æ•°æ®çš„åŠ æ³•**
> åœ¨ RV32I ä¸­æ˜¯é€šè¿‡ sltu è®¡ç®—è¿›ä½æ¥å®ç°çš„
~~~ asm
add a0,a2,a4 # åŠ ä½ 32 ä½: a0 = a2 + a4
sltu a2,a0,a2 # è‹¥ (a2+a4) < a2 é‚£ä¹ˆ a2â€™ = 1, å¦åˆ™ a2â€™ = 0
add a5,a3,a5 # åŠ é«˜ 32 ä½: a5 = a3 + a5
add a1,a2,a5 # åŠ ä¸Šä½ 32 ä½çš„è¿›ä½
~~~

**è½¯ä»¶æ£€æŸ¥æº¢å‡º**
> RISC-V ä¾èµ–äºè½¯ä»¶æº¢å‡ºæ£€æŸ¥
~~~ asm
add t0, t1, t2
slti t3, t2, 0 # t3 = (t2<0)
slt t4, t0, t1 # t4 = (t1+t2<t1)
bne t3, t4, overflow # è‹¥ ((t2<0) && (t1+t2>=t1)) || ((t2>=0) && (t1+t2<t1)) åˆ™ä¸ºæº¢å‡º
~~~

### 2.7 æ— æ¡ä»¶è·³è½¬

è·³è½¬å¹¶é“¾æ¥æŒ‡ä»¤ï¼ˆjalï¼‰å…·æœ‰åŒé‡åŠŸèƒ½ã€‚

è‹¥å°†ä¸‹ä¸€æ¡æŒ‡ä»¤ PC + 4 çš„åœ°å€ä¿å­˜åˆ°ç›®æ ‡å¯„å­˜å™¨ä¸­ï¼Œé€šå¸¸æ˜¯è¿”å›åœ°å€å¯„å­˜å™¨ raï¼Œä¾¿å¯ä»¥ç”¨å®ƒæ¥å®ç°è¿‡ç¨‹è°ƒç”¨ã€‚

å¦‚æœä½¿ç”¨é›¶å¯„å­˜å™¨ï¼ˆx0ï¼‰æ›¿æ¢ ra ä½œä¸ºç›®æ ‡å¯„å­˜å™¨ï¼Œåˆ™å¯ä»¥å®ç°æ— æ¡ä»¶è·³è½¬ï¼Œå› ä¸º x0 ä¸èƒ½æ›´æ”¹ã€‚

### 2.8 æ‚é¡¹

æ§åˆ¶çŠ¶æ€å¯„å­˜å™¨æŒ‡ä»¤ï¼ˆcsrrcã€csrrsã€csrrwã€csrrciã€csrrsiã€csrrwiï¼‰

`ecall` æŒ‡ä»¤ç”¨äºå‘è¿è¡Œæ—¶ç¯å¢ƒå‘å‡ºè¯·æ±‚ï¼Œä¾‹å¦‚ç³»ç»Ÿè°ƒç”¨ã€‚è°ƒè¯•å™¨ä½¿ç”¨ `ebreak` æŒ‡ä»¤å°†æ§åˆ¶è½¬ç§»åˆ°è°ƒè¯•ç¯å¢ƒã€‚

`fence` æŒ‡ä»¤å¯¹å¤–éƒ¨å¯è§çš„è®¿å­˜è¯·æ±‚ï¼Œå¦‚è®¾å¤‡ I/O å’Œå†…å­˜è®¿é—®ç­‰è¿›è¡Œä¸²è¡ŒåŒ–ã€‚å¤–éƒ¨å¯è§æŒ‡å¯¹å¤„ç†å™¨çš„å…¶ä»–æ ¸å¿ƒã€çº¿ç¨‹ï¼Œå¤–éƒ¨è®¾å¤‡æˆ–åå¤„ç†å™¨å¯è§ã€‚`fence.i` æŒ‡ä»¤åŒæ­¥æŒ‡ä»¤å’Œæ•°æ®æµã€‚

## 3 RISC-V æ±‡ç¼–è¯­è¨€

### 3.1 å¯¼è¨€

![compile](./3rd/compile.png)

### 3.2 å‡½æ•°è°ƒç”¨è§„èŒƒï¼ˆCalling conventionï¼‰

**ä¿å­˜å¯„å­˜å™¨å’Œä¸´æ—¶å¯„å­˜å™¨ä¸ºä»€ä¹ˆä¸æ˜¯è¿ç»­ç¼–å·**
> ä¸ºäº†æ”¯æŒ RV32Eâ€”â€”ä¸€ä¸ªåªæœ‰ 16 ä¸ªå¯„å­˜å™¨çš„åµŒå…¥å¼ç‰ˆæœ¬çš„ RISC-Vï¼Œåªä½¿ç”¨å¯„å­˜å™¨ x0 åˆ° x15â€”â€”ä¸€éƒ¨åˆ†ä¿å­˜å¯„å­˜å™¨å’Œä¸€éƒ¨åˆ†ä¸´æ—¶å¯„å­˜å™¨éƒ½åœ¨è¿™ä¸ªèŒƒå›´å†…ã€‚å…¶å®ƒçš„ä¿å­˜å¯„å­˜å™¨å’Œä¸´æ—¶å¯„å­˜å™¨åœ¨å‰©ä½™ 16 ä¸ªå¯„å­˜å™¨å†…ã€‚RV32E è¾ƒå°ï¼Œä½†ç”±äºå’Œ RV32I ä¸åŒ¹é…ï¼Œç›®å‰è¿˜æ²¡æœ‰ç¼–è¯‘å™¨æ”¯æŒã€‚

### 3.3 æ±‡ç¼–å™¨

æ±‡ç¼–ç¨‹åºçš„å¼€å¤´æ˜¯ä¸€äº›æ±‡ç¼–æŒ‡ç¤ºç¬¦ï¼ˆassemble directivesï¼‰ã€‚å®ƒä»¬æ˜¯æ±‡ç¼–å™¨çš„å‘½ä»¤ï¼Œå…·æœ‰å‘Šè¯‰æ±‡ç¼–å™¨ä»£ç å’Œæ•°æ®çš„ä½ç½®ã€æŒ‡å®šç¨‹åºä¸­ä½¿ç”¨çš„ç‰¹å®šä»£ç å’Œæ•°æ®å¸¸é‡ç­‰ä½œç”¨ã€‚

RISC-V ç¼–è¯‘å™¨æ”¯æŒå¤šä¸ª ABIï¼Œå…·ä½“å–å†³äº F å’Œ D æ‰©å±•æ˜¯å¦å­˜åœ¨ã€‚RV32 çš„ ABI åˆ†åˆ«åä¸º ilp32ï¼Œilp32f å’Œ ilp32dã€‚ilp32 è¡¨ç¤º C è¯­è¨€çš„æ•´å‹ï¼ˆintï¼‰ï¼Œé•¿æ•´å‹ï¼ˆlongï¼‰å’ŒæŒ‡é’ˆï¼ˆpointerï¼‰éƒ½æ˜¯ 32 ä½ï¼Œå¯é€‰åç¼€è¡¨ç¤ºå¦‚ä½•ä¼ é€’æµ®ç‚¹å‚æ•°ã€‚

**é“¾æ¥å™¨æ¾å¼›ï¼ˆlinker relaxationï¼‰**

> è·³è½¬å¹¶é“¾æ¥æŒ‡ä»¤ï¼ˆjump and linkï¼‰ä¸­æœ‰ 20 ä½çš„ç›¸å¯¹åœ°å€åŸŸï¼Œå› æ­¤ä¸€æ¡æŒ‡ä»¤å°±è¶³å¤Ÿè·³åˆ°å¾ˆè¿œçš„ä½ç½®ã€‚å°½ç®¡ç¼–è¯‘å™¨ä¸ºæ¯ä¸ªå¤–éƒ¨å‡½æ•°çš„è·³è½¬éƒ½ç”Ÿæˆäº†ä¸¤æ¡æŒ‡ä»¤ï¼Œå¾ˆå¤šæ—¶å€™å…¶å®ä¸€æ¡å°±å·²ç»è¶³å¤Ÿäº†ã€‚ä»ä¸¤æ¡æŒ‡ä»¤åˆ°ä¸€æ¡çš„ä¼˜åŒ–åŒæ—¶èŠ‚çœäº†æ—¶é—´å’Œç©ºé—´å¼€é”€ï¼Œå› æ­¤é“¾æ¥å™¨ä¼šæ‰«æå‡ éä»£ç ï¼Œå°½å¯èƒ½åœ°æŠŠä¸¤æ¡æŒ‡ä»¤æ›¿æ¢ä¸ºä¸€æ¡ã€‚æ¯æ¬¡æ›¿æ¢ä¼šå¯¼è‡´å‡½æ•°å’Œè°ƒç”¨å®ƒçš„ä½ç½®ä¹‹é—´çš„è·ç¦»ç¼©çŸ­ï¼Œæ‰€ä»¥é“¾æ¥å™¨ä¼šå¤šæ¬¡æ‰«ææ›¿æ¢ï¼Œç›´åˆ°ä»£ç ä¸å†æ”¹å˜ã€‚è¿™ä¸ªè¿‡ç¨‹ç§°ä¸ºé“¾æ¥å™¨æ¾å¼›ï¼Œåå­—æ¥æºäºæ±‚è§£æ–¹ç¨‹ç»„çš„æ¾å¼›æŠ€æœ¯ã€‚é™¤äº†è¿‡ç¨‹è°ƒç”¨ä¹‹å¤–ï¼Œå¯¹äº gp æŒ‡é’ˆÂ±2KiB èŒƒå›´å†…çš„æ•°æ®è®¿é—®ï¼ŒRISC-V é“¾æ¥å™¨ä¹Ÿä¼šä½¿ç”¨ä¸€ä¸ªå…¨å±€æŒ‡é’ˆæ›¿æ¢æ‰ lui å’Œ auipc ä¸¤æ¡æŒ‡ä»¤ã€‚å¯¹ tp æŒ‡é’ˆÂ±2KiB èŒƒå›´å†…çš„çº¿ç¨‹å±€éƒ¨å˜é‡è®¿é—®ä¹Ÿæœ‰ç±»ä¼¼çš„å¤„ç†ã€‚

| Directive           | Description                                                  |
| ------------------- | ------------------------------------------------------------ |
| .align n            | Align the next datum on a 2^n byte boundary.                 |
| .balign n           | Align the next datum on a n byte boundary.                   |
| .string "str"       | Store the string str in memory and null-terminate it.        |
| .byte b1, ..., bn   | Store the n 8-bit quantities in successive bytes of memory.  |
| .half h1, ..., hn   | Store the n 16-bit quantities in successive bytes of memory. |
| .word w1, ..., wn   | Store the n 32-bit quantities in successive bytes of memory. |
| .dword d1, ..., dn  | Store the n 64-bit quantities in successive bytes of memory. |
| .float f1, ..., fn  | Store the n single-precision floating-point numbers in successive memory words. |
| .double d1, ..., dn | Store the n double-precision floating-point numbers in successive memory words. |
| .option rvc         | Compress subsequent instructions.                            |
| .option norvc       | Don't compress subsequent instructions.                      |
| .option relax       | Allow linker relaxations for subsequent instructions.        |
| .option norelax     | Don't allow linker relaxations for subsequent instructions.  |
| .option pic         | Subsequent instructions are position-independent code.       |
| .option nopic       | Subsequent instructions are position-dependent code.         |
| .option push        | Push the current setting of all .option to a stack, so that a subsequent .option pop will restore their value. |
| .option pop         | Pop the option stack, restoring all .option to their setting at the time of the last .option push. |

### 3.5 é™æ€é“¾æ¥å’ŒåŠ¨æ€é“¾æ¥

ç¼–è¯‘å™¨äº§ç”Ÿçš„ä»£ç å’Œé™æ€é“¾æ¥çš„ä»£ç å¾ˆç›¸ä¼¼ã€‚å…¶ä¸åŒä¹‹å¤„åœ¨äºï¼Œè·³è½¬çš„ç›®æ ‡ä¸æ˜¯å®é™…çš„å‡½æ•°ï¼Œè€Œæ˜¯ä¸€ä¸ªåªæœ‰ä¸‰æ¡æŒ‡ä»¤çš„å­˜æ ¹å‡½æ•°ï¼ˆstub unctionï¼‰ã€‚å­˜æ ¹å‡½æ•°ä¼šä»å†…å­˜ä¸­çš„ä¸€ä¸ªè¡¨ä¸­åŠ è½½å®é™…çš„å‡½æ•°çš„åœ°å€å¹¶è·³è½¬ã€‚ä¸è¿‡ï¼Œåœ¨ç¬¬ä¸€æ¬¡è°ƒç”¨æ—¶ï¼Œè¡¨ä¸­è¿˜æ²¡æœ‰å®é™…çš„å‡½æ•°çš„åœ°å€ï¼Œåªæœ‰ä¸€ä¸ªåŠ¨æ€é“¾æ¥çš„è¿‡ç¨‹çš„åœ°å€ã€‚å½“è¿™ä¸ªåŠ¨æ€é“¾æ¥è¿‡ç¨‹è¢«è°ƒç”¨æ—¶ï¼ŒåŠ¨æ€é“¾æ¥å™¨é€šè¿‡ç¬¦å·è¡¨æ‰¾åˆ°å®é™…è¦è°ƒç”¨çš„å‡½æ•°ï¼Œå¤åˆ¶åˆ°å†…å­˜ä¸­ï¼Œæ›´æ–°è®°å½•å®é™…çš„å‡½æ•°åœ°å€çš„è¡¨ã€‚åç»­çš„æ¯æ¬¡è°ƒç”¨çš„å¼€é”€å°±æ˜¯å­˜æ ¹å‡½æ•°çš„ä¸‰æ¡æŒ‡ä»¤çš„å¼€é”€ã€‚

## 4 ä¹˜æ³•å’Œé™¤æ³•æŒ‡ä»¤






