# TCP/IP 网络模型

[TOC]

## 1 网络的分层体系结构

计算机网络是一个非常庞大且复杂的系统，所以在设计之初就严格遵守着分层的设计理念。分层将庞大的问题细分为了若干个局部的小问题，具有下列好处：
* 分层隔离
* 灵活性好
* 易于实现和维护
* 能促进标准化工作

主流网络分层体系结构有两种：
1. OSI（Open Systems Interconnection Reference Model，开放系统互联基本参考模型），就是常说的七层网络模型
2. TCP/IP（Transmission Control Protocol/Internet Protocol，传输控制协议/因特网协议）四层网络模型，以其中最重要的 TCP 协议和 IP 协议命名

![OSI_TCPIP](./images/OSI_TCPIP.jpg)

因为 OSI 的设计过于理想不合实际，再加上当时应用 TCP/IP 模型的因特网（Internet）已经覆盖了全球大部分地区。TCP/IP 模型则被作为了事实上的国际标准。

## 2 TCP/IP 网络模型

![data_flow](./images/data_flow.webp)

* 应用层的 “HTTP 数据” 是实际需要被传输的数据
* “HTTP 数据” 被下发到传输层，并添加上 TCP 首部成为传输层的 PDU（Protocol Data Unit，协议数据单元），称作数据段（Segment）
* 数据段再被下发到网络层，添加了 IP 首部后成为网络层的 PDU，称作数据包（Packet）
* 数据包再被下发到数据链路层添加了 Ethernet 首部后得到的 PDU 被称为数据帧（Frame）
* 数据帧最后被下发到物理层，以 01 电信号（比特数据位）的形式在物理介质中传输

![data_frame](./images/data_frame.jpg)

### 2.1 物理介质层

物理介质是连接网络终端设备（计算机、交换机、路由器）的物理手段，物理介质层主要解决的问题是：
* 规范了网络终端设备之间的电气、机械、流程和功能等方面的要求
* 规范了电频、速率、最大传输距离和物理接口等特征

### 2.2 数据链路层

数据链路层先后提出过包括有 Ethernet v.2、IEEE 802.2、Internetwork 在内的多种协议，其中又以 Ethernet 协议占据主导地位。

#### 2.2.1 Ethernet 协议

Ethernet 协议，即以太网协议，规定了电信号的分组方式。一组电信号称为一个数据帧，数据帧又由帧首、数据和帧尾三部分组成。

![ethernet](./images/ethernet.jpg)

* 数据帧首部：占 14 字节，包含有目标主机网卡 MAC 地址、源主机网卡 MAC 地址以及数据帧类型标识
* 数据：从上层（网络层）传递下来的数据包，范围在 [46, 1500] 个字节之间
* 数据帧尾部：占 4 个字节，是 CRC 校验序列，用来确定数据帧在传输过程中是否有损坏

#### 2.2.2 MAC 地址

![mac](./images/mac.png)

MAC 地址为 6 字节，使用 12 个十六进制数表示，e.g. 00:01:6C:06:A6:29
* 前 6 个十六进制数为厂商编号，由 IEEE（电气和电子工程师协会）分配给厂商
* 后 6 个则为该厂商的网卡流水号，由厂商自己分配

**以太网协议数据帧定位原理**

以太网协议采用广播形式，将数据帧发给本地网络内所有的主机，主机在接收数据帧后会解析数据帧首部的目标主机网卡 MAC 地址，再和自身的网卡 MAC 地址对比。若相同，就接收数据帧做下一步处理。若不同，则丢弃。

![mac_broadcast](./images/mac_broadcast.jpg)

为了增幅广播的性能和组网的灵活性，一般会在本地网络中架设交换机来支持信号转发，交换机也是数据链路层的代表设备。

![switch](./images/switch.jpg)

数据链路层主要解决的问题是：对电信号进行分组并形成具有特定意义的数据帧，然后以广播的形式通过物理介质发送给接收方。

### 2.3 网络层

从理论来讲，使用 MAC 地址就可以实现定位到这里世界上任意一台计算机，前提是广播的作用域也是全球范围的，但这并不现实。MAC 地址的定位方式存在本地子网的局限性。

所以除了以太网协议之外，还迫切的需要解决下列问题：
* 如何轻易的进行子网划分
* 如何隔离子网之间的广播信号
* 在隔离广播信号的前提下，如何保证子网之间的计算机依旧能够通信

#### 2.3.1 IP 协议

IP（Internet Protocol，因特网协议）是网络层的核心协议，规定了网络层的封装规范，将上层（传输层）传递下来的数据段附加上 IP 首部封装成 IP 数据包，又称数据报文，IP 数据包同样由包首部和数据两部分组成，只是数据部分实际为传输层的数据段。

![IP_frame](./images/IP_frame.png)

数据包首部长度为 20 字节，数据部分最大长度为 65515 字节，一个 IP 数据包总长达 65535 字节。而下层数据帧的数据部分最长为 1500 个字节，所以如果 IP 数据包的实际长度超过了 1500，就需要对 IP 数据包进行分片处理，由多个数据帧发送。

**IP 数据包首部**

![IP_header](./images/IP_header.jpg)

* Version 版本号：标识 IP 地址的版本，目前有 IPv4 和 IPv6 两个版本
* Header Length 首部长度：标识 IP 首部长度
* Type of Service 服务类型：前 3 位标识优先级，4-7 位分别标识时延、吞吐量、可靠性、开销（一个数据包只能有一位生效)
* Total Length 总长度：标识 IP 数据包总长
* Identification 鉴定字段：IP 数据包的唯一标识，如果数据包被分片传输，接收方会根据分片中的该字段值来判断哪些分片属于同一个数据包，以此进行分片重组。通常的每发送一份数据包该值就会被加 1。
* IP Flags 标志位：标识 IP 数据包是否被分片。
* Fragment Offset 偏移量：在接收方进行分片重组时，标识分片的顺序，指明了分片起始点相对于数据包起始点的偏移量。因为 IP 协议是无连接的非可靠传输协议，所以需要该字段来应对分片传输错序的情况。
* TTL(time to live) 生存时间：标识生存时长，指明了数据报可以经过的路由器数量，防止丢失数据包的无休止传播。初始值由源主机设置（通常为32或64），每经过一个路由器，该字段值就会减 1。如果数据包的 TTL 减至 0，那么路由器会丢弃该数据包并发送一个 ICMP 超时消息给数据包的源主机 IP 地址。
* Protocol 协议：标识数据包数据部分来自于哪个协议（ICMP/IGMP/TCP/UDP/GRE/ESP）。
* Header Checksum 首部校验和：根据 IP 数据包首部计算出来的校验和
* Source Addres 源地址：IP 数据包源主机的 IP 地址
* Destination Address 目标地址：IP 数据包的目标主机 IP 地址，是网关路由的关键依据。
* Option 选项：一个可变长的可选信息

**IP 地址**

因为 MAC 地址无法满足复杂的网络环境需求，所以 IP 协议制定了一套逻辑上的网络地址（IP/子网掩码）。IP 地址有 IPv4 和 IPv6 两个版本，通过子网掩码将 IP 地址分为网络号、主机号两个部分，前者标识了一个子网，后者标识了子网中的主机。如果两台主机处在同一子网，那么它们的网络号必须是相同的。

IP 地址解决了 “如何轻易的进行子网划分” 的问题。

![IPaddress](./images/IPaddress.jpg)

****
